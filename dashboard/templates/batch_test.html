<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Batch API Test</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      margin: 0;
      padding: 24px;
    }
    .shell { max-width: 1200px; margin: 0 auto; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .pill { background: rgba(99,102,241,0.14); padding: 8px 14px; border-radius: 999px; color: #cbd5f5; font-weight: 700; }
    .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
    .card { background: #0b1220; border: 1px solid #1f2937; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    h2 { margin: 0 0 12px 0; }
    label { font-size: 13px; color: #cbd5f5; font-weight: 600; margin-bottom: 4px; display: block; }
    input, textarea {
      width: 100%; padding: 10px 12px; background: #0f172a; color: #e2e8f0;
      border: 1px solid #1f2937; border-radius: 10px; outline: none; transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, textarea:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99,102,241,0.35); }
    .inline { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .muted { color: #94a3b8; font-size: 12px; }
    button {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white; border: none; padding: 12px 18px; border-radius: 10px;
      font-weight: 700; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    button:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(99,102,241,0.35); }
    .result { background: #0f172a; border: 1px solid #1f2937; border-radius: 12px; padding: 12px; margin-top: 12px; font-size: 13px; }
    pre { white-space: pre-wrap; word-break: break-word; background: #0f172a; padding: 10px; border-radius: 10px; border: 1px solid #1f2937; }
    a { color: #93c5fd; }
    .hint { margin-top: 8px; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="topbar">
      <div class="pill">Batch API</div>
      <div class="muted">Limits: ≤50k requests per batch, ≤30B tokens per model, ≤100MB file</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Create batch</h2>
        <form id="batchForm" enctype="multipart/form-data" class="stack">
          <label for="apiKey">API Key</label>
          <input id="apiKey" type="password" placeholder="TOGETHER_API_KEY (or leave empty to use env)">

          <label for="batchFile">Batch file (.jsonl, required)</label>
          <input id="batchFile" type="file" accept=".jsonl" required>
          <div class="muted hint">File must be .jsonl, ≤100MB. Each line should match the Batch API schema.</div>

          <div class="inline" style="gap:12px; margin-top:12px;">
            <button type="submit" id="createBtn">Create batch</button>
            <span id="createStatus" class="muted">Idle</span>
          </div>
        </form>

        <div id="createResult" class="result" style="display:none;">
          <div><strong>Created:</strong> <span id="batchId"></span></div>
          <div><strong>File ID:</strong> <span id="fileId"></span></div>
          <div class="hint muted">Save the batch_id to check status later.</div>
          <pre id="batchRaw"></pre>
        </div>
      </div>

      <div class="card">
        <h2>Check status</h2>
        <form id="statusForm" class="stack">
          <label for="statusApiKey">API Key</label>
          <input id="statusApiKey" type="password" placeholder="TOGETHER_API_KEY (or leave empty to use env)">

          <label for="statusBatchId">Batch ID</label>
          <input id="statusBatchId" type="text" placeholder="batch-...">

          <div class="inline" style="gap:12px; margin-top:12px;">
            <button type="submit" id="statusBtn">Get status</button>
            <span id="statusText" class="muted">Idle</span>
          </div>
        </form>

        <div id="statusResult" class="result" style="display:none;">
          <pre id="statusRaw"></pre>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h2>Notes</h2>
      <ul class="muted">
        <li>Batch API uses separate rate limits; it won’t consume standard per-model limits.</li>
        <li>Per docs: ≤30B tokens enqueued per model, ≤50,000 requests per batch, ≤100MB batch file.</li>
        <li>Endpoint used: <code>/v1/chat/completions</code>. Each line in the .jsonl must include a unique <code>custom_id</code> and a valid request body.</li>
      </ul>
    </div>
  </div>

  <script>
    const createForm = document.getElementById('batchForm');
    const statusForm = document.getElementById('statusForm');
    const createBtn = document.getElementById('createBtn');
    const statusBtn = document.getElementById('statusBtn');
    const createStatus = document.getElementById('createStatus');
    const statusText = document.getElementById('statusText');
    const createResult = document.getElementById('createResult');
    const statusResult = document.getElementById('statusResult');
    const batchIdSpan = document.getElementById('batchId');
    const fileIdSpan = document.getElementById('fileId');
    const batchRaw = document.getElementById('batchRaw');
    const statusRaw = document.getElementById('statusRaw');

    function showError(el, msg) {
      el.style.display = 'block';
      el.textContent = msg;
    }

    createForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      createStatus.textContent = 'Creating...';
      createBtn.disabled = true;
      createResult.style.display = 'none';

      const fd = new FormData();
      const apiKey = document.getElementById('apiKey').value.trim();
      const file = document.getElementById('batchFile').files[0];
      if (!file) {
        createStatus.textContent = 'Select a .jsonl file';
        createBtn.disabled = false;
        return;
      }
      fd.append('api_key', apiKey);
      fd.append('batch_file', file);

      try {
        const res = await fetch('/api/batch/create', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) {
          createStatus.textContent = data.error || 'Error';
        } else {
          createStatus.textContent = 'Created';
          createResult.style.display = 'block';
          batchIdSpan.textContent = data.batch?.id || 'n/a';
          fileIdSpan.textContent = data.file_id || 'n/a';
          batchRaw.textContent = JSON.stringify(data, null, 2);
        }
      } catch (err) {
        createStatus.textContent = err.message || 'Error';
      } finally {
        createBtn.disabled = false;
      }
    });

    statusForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusText.textContent = 'Checking...';
      statusBtn.disabled = true;
      statusResult.style.display = 'none';

      const apiKey = document.getElementById('statusApiKey').value.trim();
      const batchId = document.getElementById('statusBatchId').value.trim();
      if (!batchId) {
        statusText.textContent = 'Batch ID required';
        statusBtn.disabled = false;
        return;
      }

      const url = new URL(`/api/batch/status/${encodeURIComponent(batchId)}`, window.location.origin);
      if (apiKey) {
        url.searchParams.set('api_key', apiKey);
      }

      try {
        const res = await fetch(url);
        const data = await res.json();
        if (!res.ok) {
          statusText.textContent = data.error || 'Error';
        } else {
          statusText.textContent = 'Done';
          statusResult.style.display = 'block';
          statusRaw.textContent = JSON.stringify(data, null, 2);
        }
      } catch (err) {
        statusText.textContent = err.message || 'Error';
      } finally {
        statusBtn.disabled = false;
      }
    });
  </script>
</body>
</html>

